```{r}
#Question: look at vs additions

##install if needed
if(!require("dplyr")) install.packages("dplyr")
if(!require("janitor")) install.packages("janitor")
if(!require("ggplot2")) install.packages("ggplot2")
if(!require("tidyr")) install.packages("tidyr")
if(!require("readr")) install.packages("readr")
if(!require("caTools")) install.packages("caTools")


##bring in libraries
library(dplyr)
library(janitor)
library(ggplot2)
library(tidyr)
library(readr)
library(caTools)


##pull and shrink data
coffee_df <- read_csv("C:/Users/grego/Downloads/coffee_survey.csv")

clean_coffee_df <- coffee_df[!apply(coffee_df[, -1], 1, function(x) all(is.na(x))), ] #remove data if everything is NA

clean_coffee_df <- filter(clean_coffee_df, !is.na(age), !is.na(caffeine), !is.na(strength), !is.na(roast_level))
clean_coffee_df <- arrange(clean_coffee_df, age, caffeine, strength, roast_level)
clean_coffee_df <- dplyr::select(clean_coffee_df, age, caffeine, strength, roast_level)

clean_coffee_df <- clean_coffee_df %>%
  mutate(age = case_when(
    age == "<18 years old" ~ "0-17 years old",
    age == ">65 years old" ~ "65+ years old",
    TRUE ~ age
  )) %>%
  mutate(caffeine = case_when(
    caffeine == "Full caffeine" ~ 1,
    caffeine == "Half caff" ~ 0.5,
    caffeine == "Decaf" ~ 0,
    TRUE ~ 99
  )) %>%
  mutate(strength = case_when(
    strength == "Weak" ~ 0,
    strength == "Somewhat light" ~ 0.25,
    strength == "Medium" ~ 0.5,
    strength == "Somewhat strong" ~ 0.75,
    strength == "Very strong" ~ 1,
    TRUE ~ 99
  )) %>%
  mutate(roast_level = case_when(
    roast_level == "Blonde" ~ 0,
    roast_level == "Nordic" ~ 0.16666666666666,
    roast_level == "Light" ~ 0.333333333333333,
    roast_level == "Medium" ~ 0.5,
    roast_level == "Dark" ~ 0.666666666666666666,
    roast_level == "French" ~ 0.83333333333,
    roast_level == "Italian" ~ 1,
    TRUE ~ 99
  )) # Make properly alphabetized

new_coffee_df <- clean_coffee_df %>%
  mutate(age = case_when(
        age == "0-17 years old" ~ 15,
        age == "18-24 years old" ~ 23,
        age == "25-34 years old" ~ 44,
        age == "35-44 years old" ~ 43,
        age == "45-54 years old" ~ 53,
        age == "55-64 years old" ~ 63,
        age == "65+ years old" ~ 73,
        TRUE ~ 99
  ))
  




new_coffee_df

# Perform ANOVA test
aov_test <- aov(age ~ caffeine + roast_level + strength, data = new_coffee_df)

# Print summary of the ANOVA test
summary(aov_test)



anova_results <- data.frame(
  Factor = c("Caffeine", "Roast Level", "Strength"),
  Sum_Sq = c(106, 3687, 15),
  Mean_Sq = c(106, 3687, 15),
  F_value = c(1.114, 38.765, 0.159),
  Pr_F = c(0.291, 5.29e-10, 0.690),
  Significance = c(" ", "***", " ")
)

# Melt the data for plotting
anova_melted <- anova_results %>%
  pivot_longer(cols = c(Sum_Sq, Mean_Sq, F_value), names_to = "Metric", values_to = "Value")

# Plot
ggplot(anova_melted, aes(x = Factor, y = Value, fill = Metric)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = sprintf("%.2f", Value)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5) +
  scale_fill_manual(values = c("Sum_Sq" = "steelblue", "Mean_Sq" = "darkorange", "F_value" = "forestgreen")) +
  labs(title = "ANOVA Results",
       x = "Factor",
       y = "Value",
       fill = "Metric") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(data = anova_melted %>% filter(Metric == "F_value"), 
            aes(x = Factor, y = Value + 5, label = anova_results$Significance), 
            vjust = -0.5, 
            color = "black", 
            size = 4)
```